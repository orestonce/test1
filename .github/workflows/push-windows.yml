name: Build OpenCC with Doxygen on Windows

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      DOXYGEN_ROOT: C:\Program Files\doxygen  # Doxygen 根目录

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: BYVoid/OpenCC
          path: OpenCC

      - name: Install dependencies
        run: |
          # 安装 CMake, Ninja, Doxygen（指定安装路径为 DOXYGEN_ROOT）
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
          choco install ninja -y
          choco install doxygen.install -y --params "/DoxygenInstallDir=$DOXYGEN_ROOT"

      - name: Manually add Doxygen to PATH
        run: |
          # 将 Doxygen 的 bin 目录添加到系统环境变量（即时生效，无需刷新）
          $env:PATH = "$DOXYGEN_ROOT\bin;$env:PATH"
          Write-Host "Updated PATH: $env:PATH"  # 验证路径是否添加

      - name: Verify Doxygen installation
        run: |
          doxygen --version  # 应输出版本号，如 1.9.6
          where doxygen  # 应输出 Doxygen.exe 的路径

      - name: Configure build with documentation
        working-directory: OpenCC
        run: |
          cmake -B build `
            -G "Ninja" `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_DOCUMENTATION=ON `
            -DDOXYGEN_EXECUTABLE=$DOXYGEN_ROOT\bin\doxygen.exe  # 显式指定路径

          cmake --build build --config Release

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: opencc-windows-binaries-docs
          path: |
            OpenCC/build/bin/*.exe
            OpenCC/build/doc/html/**/*
          retention-days: 30
